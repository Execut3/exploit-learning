This section will cover exploiting provided binary which have format-string vulnerability.

### Gathering Info
First we need to gather some info about file, here are output of some commands:

```bash
$ file gotmilk
gotmilk: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=703440832efdbe6e4cbf734b303a31c4da7eb4e2, with debug_info, not stripped
```
From `file` command result, now we know that it's a 32bit ELF binary.

Now checksec:

```bash
$ checksec --file=gotmilk
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH	Symbols		FORTIFY	Fortified	Fortifiable	FILE
Partial RELRO   No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   76) Symbols	  No	0		2		gotmilk
```

Now let's run program and see how it works:
```bash
$ chmod +x gotmilk
$ ./gotmilk 
./gotmilk: error while loading shared libraries: libmylib.so: cannot open shared object file: No such file or directory
```
And we can see that it need `libmylib.so` file to be in Linux shared librarise to run the program.
To fix that we do the following sequence:
```bash
$ LD_LIBRARY_PATH=/ur/local/lib
$ sudo cp libmylib.so /usr/local/lib
$ sudo ldconfig
```

Now running the program will give us following:
```bash
$ ./gotmilk
Simulating loss...

No flag for you!
Hey you! GOT milk? here
Your answer: here

No flag for you!

```
I first tried to overflow the input, But nothing happened and seem the code is covering this vuln.
Next tried to run some format string related inputs.
```bash
$ ./gotmilk 
Simulating loss...

No flag for you!
Hey you! GOT milk? %1$8p
Your answer:     0x64

No flag for you!


[execut3@Execut3 no-category]$ ./gotmilk 
Simulating loss...

No flag for you!
Hey you! GOT milk? %2$8p    
Your answer: 0xf7ee4540

No flag for you!

```
And as u can see we can read from stack with format string vulnerability.

### Decompiling 
Let decompile the code in ida pro. Here is the decompiled code for gotmilk:

```c
int __cdecl main(int argc, const char **argv, const char **envp)
{
  char input[100]; // [esp+0h] [ebp-6Ch] BYREF
  int *p_argc; // [esp+64h] [ebp-8h]

  p_argc = &argc;
  setvbuf(stdout, 0, 2, 0);
  setvbuf(stdin, 0, 2, 0);
  setvbuf(stderr, 0, 2, 0);
  puts("Simulating loss...");
  lose();
  printf("Hey you! GOT milk? ");
  fgets(input, 100, stdin);
  printf("Your answer: ");
  printf(input);
  lose();
  return 0;
}
```

As u can see the vulnerability is in `printf(input)` part.

Now let's also open `libmylib.so` in ida pro; and see if we find out anything interesting there too.

```c
void win()
{
  int c; // [esp+8h] [ebp-10h]
  FILE *file; // [esp+Ch] [ebp-Ch]

  file = fopen("flag.txt", "r");
  if ( file )
  {
    while ( 1 )
    {
      c = getc(file);
      if ( c == -1 )
        break;
      putchar(c);
    }
    fclose(file);
  }
}
```
There is `win()` function will help us read the flag. to do so, we should simply point to this method in `gotmilk` binary input and read the flag with this function.

### Exploit
